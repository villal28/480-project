

import 'dart:io' show Platform;
import 'package:flutter/material.dart';
import 'package:flutter_blue_plus/flutter_blue_plus.dart';
import 'package:permission_handler/permission_handler.dart';

class BleSmokeTest extends StatefulWidget {
  const BleSmokeTest({super.key});
  @override
  State<BleSmokeTest> createState() => _BleSmokeTestState();
}

class _BleSmokeTestState extends State<BleSmokeTest> {
  final List<ScanResult> _seen = [];
  bool _scanning = false;
  String _log = '';

  void _append(String s) => setState(() => _log += '$s\n');

  @override
  void initState() {
    super.initState();
    _runTest();
  }

  Future<void> _runTest() async {
    if (!Platform.isIOS) {
      _append('[BLE] This test is intended for iOS.');
      return;
    }

    final supported = await FlutterBluePlus.isSupported;
    _append('[BLE] supported: $supported');

    final state = await FlutterBluePlus.adapterState.first;
    _append('[BLE] adapterState: $state');
    if (state != BluetoothAdapterState.on) {
      _append('[BLE] Turn Bluetooth ON in Settings/Control Center.');
      return;
    }

    // Request **Bluetooth** permission (NOT location) on iOS
    final bt = await Permission.bluetooth.request();
    _append('[BLE] permission: $bt');
    if (bt.isPermanentlyDenied) {
      await openAppSettings();
      return;
    }
    if (!bt.isGranted && !bt.isLimited) return;

    // Listen BEFORE starting the scan so early packets are not missed
    final sub = FlutterBluePlus.scanResults.listen((results) {
      for (final r in results) {
        if (_seen.indexWhere((e) => e.device.remoteId == r.device.remoteId) < 0) {
          final id = r.device.remoteId.str;
          final name = (r.advertisementData.advName?.isNotEmpty ?? false)
              ? r.advertisementData.advName!
              : (r.device.platformName.isNotEmpty ? r.device.platformName : '(no name)');
          _append('[BLE] hit: $name  id=$id  RSSI=${r.rssi}  '
                  'services=${r.advertisementData.serviceUuids}');
          setState(() => _seen.add(r));
        }
      }
    });

    setState(() => _scanning = true);
    await FlutterBluePlus.startScan(timeout: const Duration(seconds: 8));
    await Future.delayed(const Duration(seconds: 8));
    await FlutterBluePlus.stopScan();
    await sub.cancel();
    setState(() => _scanning = false);

    _append('[BLE] scan done. found=${_seen.length}');
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: const Text('BLE Smoke Test (iOS)')),
      body: Column(
        children: [
          if (_scanning) const LinearProgressIndicator(),
          Expanded(
            child: ListView.builder(
              itemCount: _seen.length,
              itemBuilder: (_, i) {
                final r = _seen[i];
                final name = (r.advertisementData.advName?.isNotEmpty ?? false)
                    ? r.advertisementData.advName!
                    : (r.device.platformName.isNotEmpty ? r.device.platformName : '(no name)');
                return ListTile(
                  title: Text(name),
                  subtitle: Text('${r.device.remoteId.str}  â€¢  RSSI ${r.rssi}'),
                );
              },
            ),
          ),
          const Divider(height: 1),
          Expanded(
            child: SingleChildScrollView(
              padding: const EdgeInsets.all(12),
              child: Text(_log, style: const TextStyle(fontFamily: 'monospace')),
            ),
          ),
          const SizedBox(height: 8),
          Padding(
            padding: const EdgeInsets.all(12.0),
            child: FilledButton(
              onPressed: _runTest,
              child: const Text('Rescan'),
            ),
          ),
        ],
      ),
    );
  }
}
